# CashbackMovement Schema

The `cashback_movements` table tracks every cashback credit generated by an
eligible transaction. Each row captures the raw rule input, the computed payout
and metadata required for budgeting enforcement and audit history.

## Field mapping

| Column | Type | Notes |
| --- | --- | --- |
| `cashback_movement_id` | `varchar(36)` | Primary key, typically a UUID. |
| `transaction_id` | `varchar(36)` | Foreign key to `transactions.transaction_id`. Required. |
| `account_id` | `varchar(36)` | Foreign key to `accounts.account_id`. Mirrors the transaction owner. |
| `cycle_tag` | `varchar(10)` | Budget cycle tag (YYYY-MM). Required for enforcement. |
| `cashback_type` | enum | `percent` = treat `cashback_value` as a decimal percent, `fixed` = treat as currency amount. |
| `cashback_value` | `numeric(18,4)` | Raw value from the cashback rule. Percent inputs are decimals (1.5 = 1.5%), fixed inputs are direct currency values. |
| `cashback_amount` | `numeric(18,2)` | Final monetary amount credited after applying the rule and any cap. |
| `status` | enum | `init`, `applied`, `exceed_cap`, `invalidated`. |
| `budget_cap` | `numeric(18,2)` | Optional snapshot of the cycle budget used during validation. |
| `note` | `text` | Optional reviewer or automation notes. |
| `created_at` | `timestamptz` | Record creation time. |
| `updated_at` | `timestamptz` | Last mutation time. |

## Business logic and validation

- **Percent vs fixed interpretation**: When `cashback_type = 'percent'`, treat
  `cashback_value` as a decimal percent and multiply by the transaction amount
  (`1.5` = 1.5%). When `cashback_type = 'fixed'`, use the value directly as a
  currency amount. Validation should prevent negative values and ensure the
  type/value pairing makes sense (e.g. disallow `percent` with values over 100).
- **Budget enforcement**: For any `cycle_tag`, the sum of `cashback_amount` for
  the same `account_id` cannot exceed the configured budget cap. Store the cap in
  `budget_cap` for audit and UI messaging. Movements that would exceed the cap
  should transition to `status = 'exceed_cap'`.
- **Lifecycle transitions**: `init` â†’ `applied` once credited. If the payout is
  blocked by the budget, mark as `exceed_cap`. Manual or automated reversals
  should use `invalidated` and append a `note`.

## UI hints

- Display helper text when entering the cashback value explaining the
  percent vs fixed interpretation.
- Surface the `budget_cap` and cumulative credited amount for the selected
  `account_id`/`cycle_tag` to warn users before the cap is exceeded.
- When a movement sits in `exceed_cap`, prompt for manual review or allow the
  reviewer to adjust the cap before re-processing.
