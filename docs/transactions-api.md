# Transactions API Modular Endpoints

This document summarizes the modular backend endpoints that power the Transactions table. Each endpoint shares a consistent schema surface so the frontend can hydrate the table, filters, actions, and restore UX without additional mapping.

## Base Table Endpoint

- **Route:** `GET /api/transactions`
- **Purpose:** Fetch paginated table data with applied search, filters, sort, quick filters, and restore metadata.
- **Query Parameters:**
  - `search` – free text search across id, notes, shop, account, category, owner, debt tag, cycle tag, linked transaction.
  - `page`, `pageSize` – pagination controls (defaults 1 / 25).
  - `sort` – comma separated list (`date:desc,amount:asc`) or JSON array of sort descriptors.
  - `quickFilterId` – optional preset id (`recent-expenses`, `cashback-only`, `high-value`).
  - Filter params: `owner`, `category`, `type`, `debtTag`, `account`, `month`, `year`, `tag`, `from`, `to` (multi-select supported by repeating the query param).
  - `restoreToken` or `X-Transaction-Restore` header – base64 token generated by a prior response.
- **Response Body (excerpt):**
  ```json
  {
    "rows": [
      {
        "id": "txn-0002",
        "occurredOn": "2025-02-13",
        "amount": 320,
        "totalBack": 0,
        "finalPrice": 320,
        "owner": "Iris",
        "category": "Cashback"
      }
    ],
    "pagination": { "page": 1, "pageSize": 25, "totalRows": 42, "totalPages": 2 },
    "totals": { "count": 42, "amount": 8421.12, "totalBack": 612.77, "finalPrice": 7808.35 },
    "sort": [{ "id": "date", "direction": "desc" }],
    "filters": {
      "applied": {
        "owners": [],
        "categories": [],
        "types": ["Income"],
        "dateRange": null,
        "searchTags": []
      },
      "options": {
        "owners": ["Iris", "Noah", "Rena"],
        "categories": ["Cashback", "Groceries", "Transport"],
        "types": ["Expense", "Income"],
        "debtTags": ["Auto", "Client - Juno", "Rebate"],
        "accounts": ["Primary Checking", "Rewards Wallet"],
        "months": ["February", "March"],
        "years": ["2025"]
      }
    },
    "meta": {
      "availableColumns": [...],
      "stickyColumns": { "left": ["date", "shop"], "right": ["amount", "finalPrice"] },
      "defaultSort": [{ "id": "date", "direction": "desc" }],
      "defaultFilters": { ... },
      "availableActions": ["quickEdit", "delete", "bulkDelete", "syncSelection", "syncPermissions"],
      "quickFilterOptions": [
        { "id": "recent-expenses", "matchCount": 9 },
        { "id": "cashback-only", "matchCount": 3 }
      ],
      "fieldMapping": { "amount": "amount", "date": "occurredOn" },
      "formatSettings": {
        "currency": { "locale": "en-US", "currency": "USD" },
        "date": { "locale": "en-US", "options": { "year": "numeric", "month": "short", "day": "2-digit" } }
      },
      "pagination": { "defaultPageSize": 25, "maxPageSize": 200 }
    },
    "restore": { "token": "<base64>", "state": { ... } },
    "execution": { "durationMs": 112.42 },
    "generatedAt": "2025-02-25T12:30:00.000Z"
  }
  ```

## Filter Options Endpoint

- **Route:** `GET /api/transactions/filter`
- **Purpose:** Provide dropdown lists, advanced search capabilities, and quick-filter metadata.
- **Response Body:**
  ```json
  {
    "options": {
      "owners": ["Iris", "Noah", "Rena"],
      "categories": ["Cashback", "Groceries"],
      "types": ["Expense", "Income"],
      "debtTags": ["Auto", "Client - Juno"],
      "accounts": ["Primary Checking", "Rewards Wallet"],
      "months": ["February", "March"],
      "years": ["2025"]
    },
    "advancedSearch": {
      "fields": ["owners", "categories", "types", "debtTags", "accounts", "months", "years", "dateRange"],
      "supportsMultiSelect": ["owners", "categories", "types", "debtTags"]
    },
    "quickFilters": [
      { "id": "recent-expenses", "description": "Expense transactions from the last 30 days" },
      { "id": "cashback-only" },
      { "id": "high-value" }
    ],
    "totalRows": 42,
    "generatedAt": "2025-02-25T12:30:00.000Z"
  }
  ```

## Restore Endpoint

- **Route:** `POST /api/transactions/restore`
- **Purpose:** Rehydrate table state from a restore token and optional overrides.
- **Request Body:**
  ```json
  {
    "restoreToken": "<base64>",
    "state": {
      "pagination": { "page": 1, "pageSize": 50 }
    }
  }
  ```
- **Response:** Same schema as the base table endpoint with the restored filters/search applied.

## Action Endpoint

- **Route:** `POST /api/transactions/action`
- **Purpose:** Execute row/bulk actions such as quick edit, delete, selection summary, or permissions sync.
- **Request Body Examples:**
  ```json
  { "action": "quickEdit", "payload": { "id": "txn-0003", "updates": { "notes": "Updated via QA" } } }
  { "action": "syncSelection", "payload": { "ids": ["txn-0001", "txn-0002"] } }
  { "action": "bulkDelete", "payload": { "ids": ["txn-0005", "txn-0006"] } }
  ```
- **Responses:**
  ```json
  { "status": "success", "message": "Transaction updated successfully (simulation).", "updatedRow": { ... } }
  { "status": "success", "message": "Selection summary recalculated.", "summary": { "count": 2, "amount": 500.12, "totalBack": 42.1, "finalPrice": 458.02 } }
  { "status": "error", "message": "Missing transaction id for delete action." }
  ```

## Meta Endpoint

- **Route:** `GET /api/transactions/meta`
- **Purpose:** Surface static table metadata (columns, sticky configuration, default filters/sorts, action manifest, format settings, pagination limits) for front-end bootstrapping.
- **Response Body:** Same `meta` object provided in the base table endpoint.

---

### Notes for Frontend Integration

1. The `restore.token` returned by any table response can be cached client-side and replayed through the `restore` endpoint (or via `restoreToken` query/header) to reproduce the last state.
2. Quick filter presets may extend existing filters with dynamic rules (e.g., `recent-expenses` injects a rolling 30-day window; `high-value` enforces `amount >= 500`). Always prefer the `meta.quickFilterOptions` payload to hydrate quick filter buttons.
3. All totals (`amount`, `totalBack`, `finalPrice`) are rounded to two decimals server-side to match UI display without double rounding on the client.
4. Execution timing (`execution.durationMs`) is provided for observability; alerts can be raised if the value approaches the 500ms SLA.
