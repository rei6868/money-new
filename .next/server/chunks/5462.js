"use strict";exports.id=5462,exports.ids=[5462],exports.modules={5685:(e,t,a)=>{a.d(t,{H:()=>createRestorePayload,VB:()=>mergeStateWithRestore,a_:()=>mergeStateWithRequest,lR:()=>getDefaultTableState,uI:()=>decodeRestoreToken});var n=a(2254),r=a(1637);let o=new Set(["asc","desc"]);function getDefaultSort(){let e=(0,r.C)(),t=e.availableColumns.find(e=>"date"===e.id),a=t??e.availableColumns[0],n=a?.id??"date";return{columnId:n,direction:"desc"}}function sanitizeSort(e){let t=function(){let e=(0,r.C)();return new Set(e.availableColumns.map(e=>e.id))}(),a=getDefaultSort(),n="string"==typeof e?.columnId&&t.has(e.columnId)?e.columnId:a.columnId,c=e?.direction&&o.has(e.direction)?e.direction:a.direction;return{columnId:n,direction:c}}function sanitizePagination(e,t){let a=(0,r.C)(),n=a.pagination.defaultPageSize,o=a.pagination.maxPageSize,c=Number.isFinite(e)&&e&&e>0?Math.floor(e):1,i=Number.isFinite(t)&&t&&t>0?Math.floor(t):n;return{page:c,pageSize:Math.min(Math.max(5,i),o)}}function getDefaultTableState(){let e=(0,r.C)();return{searchTerm:"",pagination:{page:1,pageSize:e.pagination.defaultPageSize},sort:getDefaultSort()}}function sanitizeState(e){let t=getDefaultTableState(),a=sanitizePagination(e?.pagination?.page,e?.pagination?.pageSize);return{searchTerm:"string"==typeof e?.searchTerm?e.searchTerm:t.searchTerm,pagination:a,sort:sanitizeSort(e?.sort)}}function createRestorePayload(e){let t=sanitizeState(e),a=JSON.stringify({v:1,state:t}),r=n.Buffer.from(a).toString("base64url");return{token:r,state:t}}function decodeRestoreToken(e){if(!e)return null;try{let t=n.Buffer.from(e,"base64url").toString("utf8"),a=JSON.parse(t);if(1!==a.v)return null;return sanitizeState(a.state)}catch(e){return null}}function mergeStateWithRequest(e,t){let a=Number(e.pagination?.page??t.pagination.page),n=Number(e.pagination?.pageSize??t.pagination.pageSize),r=sanitizePagination(a,n);return{searchTerm:"string"==typeof e.searchTerm?e.searchTerm:t.searchTerm,pagination:r,sort:sanitizeSort(e.sort??t.sort)}}function mergeStateWithRestore(e,t){let a=getDefaultTableState(),n=decodeRestoreToken(e)??a;return mergeStateWithRequest(t,n)}},5462:(e,t,a)=>{a.a(e,async(e,n)=>{try{a.d(t,{y:()=>getTransactionsTable});var r=a(8846),o=a(7612),c=a(8358),i=a(4379),s=a(3685),l=a(7126),u=a(6986),m=a(7798),d=a(6340),f=a(6391),p=a(7492),g=a(1637),b=a(5685),h=a(8968),S=e([o,c,i,s,l,u,m,d,f,p,h]);[o,c,i,s,l,u,m,d,f,p,h]=S.then?(await S)():S;let y=["id","notes","shop","account","category","owner","debtTag","cycleTag","linkedTxn"],k=new Set((0,g.C)().availableColumns.map(e=>e.id)),I=new Set(["amount","percentBack","fixedBack","totalBack","finalPrice"]),N=new Set(["date"]),x={columnId:"date",direction:"desc"};function toNumber(e,t=0){let a=Number(e);return Number.isFinite(a)?a:t}let T=new Intl.DateTimeFormat("en-US",{month:"long",timeZone:"UTC"});function roundCurrency(e){return Number(e.toFixed(2))}function determineSortState(e){let t="string"==typeof e?.columnId?e.columnId:x.columnId,a=e?.direction==="asc"||e?.direction==="desc"?e.direction:x.direction;return k.has(t)?{columnId:t,direction:a}:{...x}}function toComparableValue(e,t){let a=e?.[t];if(null==a||""===a)return null;if(I.has(t)){let e=Number(a);return Number.isFinite(e)?e:null}if(N.has(t)){let e=Date.parse(String(a));return Number.isNaN(e)?null:e}return String(a).toLowerCase()}async function buildFallbackResponse(e,t,a=(0,g.C)()){let n=await (0,h.n)(),r=t.trim().toLowerCase(),o=r?n.filter(e=>y.some(t=>String(e[t]??"").toLowerCase().includes(r))):n,c=function(e,t){if(!Array.isArray(e)||e.length<=1)return e;let{columnId:a,direction:n}=determineSortState(t);if(!a||!n)return e;let r="asc"===n?1:-1,o=e.slice();return o.sort((e,t)=>{let n=toComparableValue(e,a),o=toComparableValue(t,a);if(null===n&&null===o)return 0;if(null===n)return 1;if(null===o)return -1;if("number"==typeof n&&"number"==typeof o)return n===o?0:n<o?-1*r:1*r;let c=String(n).localeCompare(String(o),void 0,{sensitivity:"base",numeric:I.has(a)||N.has(a)});return c*r}),o}(o,e.sort),{rows:i,pagination:s}=function(e,t,a){let n=e.length,r=Math.max(1,Math.ceil(n/a)),o=Math.min(Math.max(t,1),r),c=(o-1)*a,i=c+a;return{rows:e.slice(c,i),pagination:{page:o,pageSize:a,totalRows:n,totalPages:r}}}(c,e.pagination.page,e.pagination.pageSize),l=o.reduce((e,t)=>(e.count+=1,e.amount+=t.amount,e.totalBack+=t.totalBack,e.finalPrice+=t.finalPrice,e),{count:0,amount:0,totalBack:0,finalPrice:0}),u=(0,b.H)({searchTerm:t,pagination:s,sort:determineSortState(e.sort)});return{rows:i,pagination:s,totals:{count:l.count,amount:roundCurrency(l.amount),totalBack:roundCurrency(l.totalBack),finalPrice:roundCurrency(l.finalPrice)},searchTerm:t,meta:a,restore:u,generatedAt:new Date().toISOString(),execution:{durationMs:0}}}async function getTransactionsTable(e,t){let a=r.performance.now(),n=(0,g.C)(),h=(0,b.lR)(),S=t?(0,b.VB)(t,e):(0,b.a_)(e,h),y=S.searchTerm??"",k=determineSortState(S.sort),I=(0,i.zA)();if(!I){let e=await buildFallbackResponse({searchTerm:S.searchTerm,pagination:S.pagination,sort:S.sort},y,n),t={durationMs:Number((r.performance.now()-a).toFixed(2))};return{...e,execution:t}}try{let e=(0,c.alias)(d.M,"account_owner"),t=o.sql`coalesce(max(CASE WHEN ${l.Bh.cashbackType} = 'percent' THEN ${l.Bh.cashbackValue}::numeric END), 0)`.as("percentBack"),i=o.sql`coalesce(sum(CASE WHEN ${l.Bh.cashbackType} = 'fixed' THEN ${l.Bh.cashbackValue}::numeric END), 0)`.as("fixedBack"),g=o.sql`coalesce(sum(${l.Bh.cashbackAmount}::numeric), 0)`.as("totalBack"),h=o.sql`max(${l.Bh.cycleTag})`.as("cashbackCycleTag"),N=I.$with("cashback_summary").as(I.select({transactionId:l.Bh.transactionId,percentBack:t,fixedBack:i,totalBack:g,cashbackCycleTag:h}).from(l.Bh).groupBy(l.Bh.transactionId)),x=o.sql`max(${m.iJ.cycleTag})`.as("debtCycleTag"),B=o.sql`max(${m.iJ.notes})`.as("debtNotes"),w=o.sql`max(trim(concat_ws(' ', initcap(replace(${m.iJ.movementType}::text, '_', ' ')), ${m.iJ.cycleTag})))`.as("movementLabel"),C=I.$with("debt_summary").as(I.select({transactionId:m.iJ.transactionId,debtCycleTag:x,debtNotes:B,movementLabel:w}).from(m.iJ).groupBy(m.iJ.transactionId)),q={transactions:p.dx,accounts:s.MI,accountOwner:e,people:d.M,shops:f.Of,categories:u.b,cashbackSummary:N,debtSummary:C},M=function(e,t){let a=e.trim();if(!a)return[];let n=`%${a.replace(/[%_]/g,e=>`\\${e}`)}%`,r=[(0,o.ilike)(t.transactions.transactionId,n),(0,o.ilike)(t.transactions.notes,n),(0,o.ilike)(t.shops.shopName,n),(0,o.ilike)(t.accounts.accountName,n),(0,o.ilike)(t.categories.name,n),(0,o.ilike)(t.people.fullName,n),(0,o.ilike)(t.accountOwner.fullName,n),(0,o.ilike)(t.transactions.linkedTxnId,n)];return r.push((0,o.ilike)(t.cashbackSummary.cashbackCycleTag,n)),r.push((0,o.ilike)(t.debtSummary.debtCycleTag,n)),r.push((0,o.ilike)(t.debtSummary.movementLabel,n)),r.push((0,o.ilike)(t.debtSummary.debtNotes,n)),r}(y,q),$=I.with(N,C),J=$.select({totalRows:o.sql`count(*)`,amountSum:o.sql`coalesce(sum((${p.dx.amount})::numeric), 0)`,totalBackSum:o.sql`coalesce(sum(coalesce(${N.totalBack}, 0)), 0)`,finalPriceSum:o.sql`coalesce(sum(((${p.dx.amount})::numeric) - coalesce(${N.totalBack}, 0)), 0)`}).from(p.dx).leftJoin(s.MI,(0,o.eq)(p.dx.accountId,s.MI.accountId)).leftJoin(e,(0,o.eq)(s.MI.ownerId,e.personId)).leftJoin(d.M,(0,o.eq)(p.dx.personId,d.M.personId)).leftJoin(u.b,(0,o.eq)(p.dx.categoryId,u.b.categoryId)).leftJoin(f.Of,(0,o.eq)(p.dx.shopId,f.Of.shopId)).leftJoin(N,(0,o.eq)(N.transactionId,p.dx.transactionId)).leftJoin(C,(0,o.eq)(C.transactionId,p.dx.transactionId)),O=M.length?J.where((0,o.or)(...M)):J,z=await O.execute(),D=z[0]??{totalRows:0,amountSum:0,totalBackSum:0,finalPriceSum:0},P=Number(D.totalRows??0),F=S.pagination.pageSize,R=Math.max(1,Math.ceil(P/F)),v=Math.min(Math.max(S.pagination.page,1),R),E=(v-1)*F,L={page:v,pageSize:F,totalRows:P,totalPages:R},A=[];if(P>0){let t=function(e,t){switch(e){case"date":default:return t.transactions.occurredOn;case"type":return t.transactions.type;case"account":return o.sql`coalesce(${t.accounts.accountName}, ${t.transactions.accountId})`;case"shop":return t.shops.shopName;case"notes":return t.transactions.notes;case"amount":return t.transactions.amount;case"percentBack":return o.sql`coalesce(${t.cashbackSummary.percentBack}, 0)`;case"fixedBack":return o.sql`coalesce(${t.cashbackSummary.fixedBack}, 0)`;case"totalBack":return o.sql`coalesce(${t.cashbackSummary.totalBack}, 0)`;case"finalPrice":return o.sql`(${t.transactions.amount})::numeric - coalesce(${t.cashbackSummary.totalBack}, 0)`;case"debtTag":return o.sql`coalesce(${t.debtSummary.movementLabel}, ${t.debtSummary.debtNotes}, '')`;case"cycleTag":return o.sql`coalesce(${t.debtSummary.debtCycleTag}, ${t.cashbackSummary.cashbackCycleTag}, '')`;case"category":return t.categories.name;case"linkedTxn":return t.transactions.linkedTxnId;case"owner":return o.sql`coalesce(${t.people.fullName}, ${t.accountOwner.fullName}, '')`;case"id":return t.transactions.transactionId}}(k.columnId,{transactions:p.dx,accounts:s.MI,accountOwner:e,people:d.M,shops:f.Of,categories:u.b,cashbackSummary:N,debtSummary:C}),a="asc"===k.direction?(0,o.asc)(t):(0,o.desc)(t),n=$.select({transactionId:p.dx.transactionId,occurredOn:p.dx.occurredOn,amount:p.dx.amount,type:p.dx.type,notes:p.dx.notes,linkedTxnId:p.dx.linkedTxnId,accountName:s.MI.accountName,accountId:p.dx.accountId,accountOwnerName:e.fullName,personName:d.M.fullName,categoryName:u.b.name,shopName:f.Of.shopName,percentBack:N.percentBack,fixedBack:N.fixedBack,totalBack:N.totalBack,cashbackCycle:N.cashbackCycleTag,debtCycle:C.debtCycleTag,debtLabel:C.movementLabel,debtNotes:C.debtNotes}).from(p.dx).leftJoin(s.MI,(0,o.eq)(p.dx.accountId,s.MI.accountId)).leftJoin(e,(0,o.eq)(s.MI.ownerId,e.personId)).leftJoin(d.M,(0,o.eq)(p.dx.personId,d.M.personId)).leftJoin(u.b,(0,o.eq)(p.dx.categoryId,u.b.categoryId)).leftJoin(f.Of,(0,o.eq)(p.dx.shopId,f.Of.shopId)).leftJoin(N,(0,o.eq)(N.transactionId,p.dx.transactionId)).leftJoin(C,(0,o.eq)(C.transactionId,p.dx.transactionId)).orderBy(a,(0,o.desc)(p.dx.transactionId)).limit(F).offset(E),r=M.length?n.where((0,o.or)(...M)):n,c=await r.execute();A=c.map(e=>(function(e){var t;let a=toNumber(e.amount),n=function(e){if(!e)return"";if(e instanceof Date)return Number.isNaN(e.getTime())?"":e.toISOString().slice(0,10);if("string"==typeof e){let t=e.trim();if(!t)return"";let a=new Date(`${t}T00:00:00Z`);return Number.isNaN(a.getTime())?t:a.toISOString().slice(0,10)}return""}(e.occurredOn),r=n?new Date(`${n}T00:00:00Z`):null,o=r?r.getTime():Number.NEGATIVE_INFINITY,c=!r||Number.isNaN(r.getTime())?"":T.format(r),i=r&&!Number.isNaN(r.getTime())?String(r.getUTCFullYear()):"",s=(e.type??"").trim(),l=s||((t=e.type)?t.split(/[_\\s-]+/g).filter(Boolean).map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "):"")||"Expense",u=toNumber(e.percentBack),m=toNumber(e.fixedBack),d=toNumber(e.totalBack),f=Number((a-d).toFixed(2)),p=e.personName??e.accountOwnerName??"",g=(e.debtLabel?.trim()||e.debtNotes?.trim()||"").trim(),b=e.debtCycle?.trim()||e.cashbackCycle?.trim()||"";return{id:e.transactionId,date:n,occurredOn:n,displayDate:n,sortDate:Number.isFinite(o)?o:Number.NEGATIVE_INFINITY,year:i,month:c,account:e.accountName??e.accountId??"",shop:e.shopName??"",notes:e.notes??"",amount:a,percentBack:u,fixedBack:m,totalBack:d,finalPrice:f,debtTag:g,cycleTag:b,category:e.categoryName??"",linkedTxn:e.linkedTxnId??"",owner:p,type:s||l,amountDirection:"income"===(s||e.type||"").toString().trim().toLowerCase()?"credit":"debit"}})(e))}let _={count:P,amount:roundCurrency(toNumber(D.amountSum)),totalBack:roundCurrency(toNumber(D.totalBackSum)),finalPrice:roundCurrency(toNumber(D.finalPriceSum))},V=(0,b.H)({searchTerm:y,pagination:L,sort:k}),H={durationMs:Number((r.performance.now()-a).toFixed(2))};return{rows:A,pagination:L,totals:_,searchTerm:y,meta:n,restore:V,generatedAt:new Date().toISOString(),execution:H}}catch(o){console.error("Failed to query transactions table, falling back to mock dataset.",o);let e=await buildFallbackResponse({searchTerm:S.searchTerm,pagination:S.pagination,sort:S.sort},y,n),t={durationMs:Number((r.performance.now()-a).toFixed(2))};return{...e,execution:t}}}n()}catch(e){n(e)}})}};