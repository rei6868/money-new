"use strict";(()=>{var e={};e.id=8517,e.ids=[8517],e.modules={1081:e=>{e.exports=require("dotenv/config")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7612:e=>{e.exports=import("drizzle-orm")},1749:e=>{e.exports=import("drizzle-orm/node-postgres")},8358:e=>{e.exports=import("drizzle-orm/pg-core")},8678:e=>{e.exports=import("pg")},2249:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{config:()=>c,default:()=>d,routeModule:()=>l});var o=n(1802),a=n(7153),i=n(6249),s=n(4983),u=e([s]);s=(u.then?(await u)():u)[0];let d=(0,i.l)(s,"default"),c=(0,i.l)(s,"config"),l=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/transactions/[id]",pathname:"/api/transactions/[id]",bundlePath:"",filename:""},userland:s});r()}catch(e){r(e)}})},4983:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{default:()=>handler});var o=n(7612),a=n(4379),i=n(7492),s=n(5167),u=n(7126),d=n(7798),c=e([o,a,i,s,u,d]);[o,a,i,s,u,d]=c.then?(await c)():c;let ValidationError=class ValidationError extends Error{constructor(e){super(e),this.name="ValidationError"}};function pickEditedBy(e){let t=[e.headers["x-user-id"],e.headers["x-request-user"],e.headers["x-user"],e.headers["x-actor-id"]];for(let e of t)if(e){if(Array.isArray(e)){let t=e.find(e=>"string"==typeof e&&e.trim().length>0);if(t)return t;continue}if("string"==typeof e&&e.trim().length>0)return e}return null}function normalizeNumeric(e){if(null==e)return null;let t=Number(e);return Number.isFinite(t)?t.toFixed(2):null}function coerceOptionalString(e){if(null==e||"string"!=typeof e)return null;let t=e.trim();return t.length>0?t:null}async function getCashbackTotal(e,t){let n=await e.select({cashbackAmount:u.Bh.cashbackAmount}).from(u.Bh).where((0,o.eq)(u.Bh.transactionId,t));if(!n.length)return null;let r=n.reduce((e,t)=>{let n=normalizeNumeric(t.cashbackAmount);return e+(n?Number(n):0)},0);return 0===r?"0.00":r.toFixed(2)}async function getDebtTotal(e,t){let n=await e.select({amount:d.iJ.amount}).from(d.iJ).where((0,o.eq)(d.iJ.transactionId,t));if(!n.length)return null;let r=n.reduce((e,t)=>{let n=normalizeNumeric(t.amount);return e+(n?Number(n):0)},0);return 0===r?"0.00":r.toFixed(2)}async function getNextSeqNo(e,t){let[n]=await e.select({maxSeq:o.sql`COALESCE(MAX(${s.Z.seqNo}), 0)`}).from(s.Z).where((0,o.eq)(s.Z.transactionId,t)),r=n?.maxSeq??0;return Number(r)+1}async function recordHistory(e,t){let n=await getNextSeqNo(e,t.transactionId);await e.insert(s.Z).values({...t,seqNo:n})}async function handler(e,t){let n=a.db;if(!n){console.error("Database connection is not configured"),t.status(500).json({error:"Database connection is not configured"});return}let r=function(e){let t=Array.isArray(e.query.id)?e.query.id[0]:e.query.id;return"string"==typeof t&&t.trim().length>0?t:null}(e);if(!r){t.status(400).json({message:"Transaction id is required"});return}if("GET"===e.method){try{let[e]=await n.select().from(i.dx).where((0,o.eq)(i.dx.transactionId,r));if(!e){t.status(404).json({message:"Transaction not found"});return}t.status(200).json(e)}catch(n){console.error(`Failed to fetch transaction ${r}`,n);let e=n instanceof Error?n.message:"Unknown error";t.status(500).json({error:e})}return}if("PUT"===e.method||"PATCH"===e.method){try{let a=e.body??{},{updates:s,hasMutations:u}=function(e){let t={},n=!1;if(void 0!==e.accountId){if(null===e.accountId)throw new ValidationError("accountId cannot be null");if("string"!=typeof e.accountId||0===e.accountId.trim().length)throw new ValidationError("accountId must be a non-empty string");t.accountId=e.accountId.trim(),n=!0}if(void 0!==e.personId&&(t.personId=coerceOptionalString(e.personId),n=!0),void 0!==e.categoryId&&(t.categoryId=coerceOptionalString(e.categoryId),n=!0),void 0!==e.shopId&&(t.shopId=coerceOptionalString(e.shopId),n=!0),void 0!==e.subscriptionMemberId&&(t.subscriptionMemberId=coerceOptionalString(e.subscriptionMemberId),n=!0),void 0!==e.linkedTxnId&&(t.linkedTxnId=coerceOptionalString(e.linkedTxnId),n=!0),void 0!==e.type){let r=i.bn.enumValues;if("string"!=typeof e.type||!r.includes(e.type))throw new ValidationError(`type must be one of: ${r.join(", ")}`);t.type=e.type,n=!0}if(void 0!==e.status){let r=i.tV.enumValues;if("string"!=typeof e.status||!r.includes(e.status))throw new ValidationError(`status must be one of: ${r.join(", ")}`);t.status=e.status,n=!0}if(void 0!==e.occurredOn){if("string"!=typeof e.occurredOn||0===e.occurredOn.trim().length)throw new ValidationError("occurredOn must be an ISO date string");let r=new Date(`${e.occurredOn}T00:00:00Z`);if(Number.isNaN(r.getTime()))throw new ValidationError("occurredOn must be a valid date");t.occurredOn=r,n=!0}if(void 0!==e.notes){if(null===e.notes)t.notes=null;else if("string"==typeof e.notes)t.notes=e.notes.trim()||null;else throw new ValidationError("notes must be a string or null");n=!0}if(void 0!==e.amount){if(null===e.amount)throw new ValidationError("amount cannot be null");let r=Number(e.amount);if(!Number.isFinite(r))throw new ValidationError("amount must be a valid number");t.amount=r.toFixed(2),n=!0}if(void 0!==e.fee){if(null===e.fee||""===e.fee)t.fee=null,n=!0;else{let r=Number(e.fee);if(!Number.isFinite(r))throw new ValidationError("fee must be a valid number");t.fee=r.toFixed(2),n=!0}}return{updates:t,hasMutations:n}}(a);if(!u){t.status(400).json({error:"No valid fields to update"});return}s.updatedAt=new Date;let d=pickEditedBy(e),c=await n.transaction(async e=>{let[t]=await e.select().from(i.dx).where((0,o.eq)(i.dx.transactionId,r));if(!t)return{kind:"not_found"};let n=normalizeNumeric(t.amount),a=await getCashbackTotal(e,r),u=await e.update(i.dx).set(s).where((0,o.eq)(i.dx.transactionId,r)).returning();if(0===u.length)return{kind:"not_found"};let c=u[0],l=normalizeNumeric(c.amount),m=await getCashbackTotal(e,r),f=function(e,t,n,r){let o=normalizeNumeric(e),a=normalizeNumeric(t),i=normalizeNumeric(n),s=normalizeNumeric(r);return o===a&&i!==s?"cashback_update":"update"}(n,l,a,m);return await recordHistory(e,{transactionId:r,oldAmount:n,newAmount:l,oldCashback:a,newCashback:m,oldDebt:null,newDebt:null,actionType:f,editedBy:d}),{kind:"success",payload:c}});if("not_found"===c.kind){t.status(404).json({message:"Transaction not found"});return}t.status(200).json(c.payload)}catch(n){if(n instanceof ValidationError){t.status(400).json({error:n.message});return}console.error(`Failed to update transaction ${r}`,n);let e=n instanceof Error?n.message:"Unknown error";t.status(500).json({error:e})}return}if("DELETE"===e.method){try{let a=pickEditedBy(e),s=await n.transaction(async e=>{let[t]=await e.select().from(i.dx).where((0,o.eq)(i.dx.transactionId,r));if(!t)return{kind:"not_found"};let n=normalizeNumeric(t.amount),s=await getCashbackTotal(e,r),c=await getDebtTotal(e,r);await recordHistory(e,{transactionId:r,oldAmount:n,newAmount:null,oldCashback:s,newCashback:null,oldDebt:c,newDebt:null,actionType:"delete",editedBy:a}),await e.delete(u.Bh).where((0,o.eq)(u.Bh.transactionId,r)),await e.delete(d.iJ).where((0,o.eq)(d.iJ.transactionId,r));let l=await e.delete(i.dx).where((0,o.eq)(i.dx.transactionId,r)).returning();return 0===l.length?{kind:"not_found"}:{kind:"success",payload:l[0]}});if("not_found"===s.kind){t.status(404).json({message:"Transaction not found"});return}t.status(200).json(s.payload)}catch(n){console.error(`Failed to delete transaction ${r}`,n);let e=n instanceof Error?n.message:"Unknown error";t.status(500).json({error:e})}return}t.setHeader("Allow",["GET","PUT","PATCH","DELETE"]),t.status(405).json({error:"Method not allowed"})}r()}catch(e){r(e)}})},5167:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.d(t,{Z:()=>s});var o=n(8358),a=e([o]);o=(a.then?(await a)():a)[0];let i=(0,o.pgEnum)("transaction_history_action",["update","delete","cashback_update"]),s=(0,o.pgTable)("transaction_history",{historyId:(0,o.uuid)("history_id").defaultRandom().primaryKey(),transactionId:(0,o.varchar)("transaction_id",{length:36}).notNull(),oldAmount:(0,o.numeric)("old_amount",{precision:18,scale:2}),newAmount:(0,o.numeric)("new_amount",{precision:18,scale:2}),oldCashback:(0,o.numeric)("old_cashback",{precision:18,scale:2}),newCashback:(0,o.numeric)("new_cashback",{precision:18,scale:2}),oldDebt:(0,o.numeric)("old_debt",{precision:18,scale:2}),newDebt:(0,o.numeric)("new_debt",{precision:18,scale:2}),actionType:i("action_type").notNull(),seqNo:(0,o.integer)("seq_no").default(1).notNull(),editedBy:(0,o.varchar)("edited_by",{length:255}),createdAt:(0,o.timestamp)("created_at",{withTimezone:!0}).defaultNow().notNull()},e=>({transactionSeqIdx:(0,o.uniqueIndex)("transaction_history_transaction_seq_idx").on(e.transactionId,e.seqNo),transactionIdIdx:(0,o.index)("transaction_history_transaction_id_idx").on(e.transactionId)}));r()}catch(e){r(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),n=t.X(0,[4222,4379,6340,3902,6986,6391,7492,7056],()=>__webpack_exec__(2249));module.exports=n})();